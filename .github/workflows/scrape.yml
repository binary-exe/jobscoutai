# Scheduled job scrape workflow
# Triggers a scrape run every 6 hours via GitHub Actions

name: Scheduled Scrape

on:
  schedule:
    # Run at 00:00, 06:00, 12:00, 18:00 UTC
    - cron: '0 */6 * * *'
  workflow_dispatch:
    inputs:
      query:
        description: 'Search query'
        required: false
        default: 'automation engineer'
      use_ai:
        description: 'Enable AI features (true/false)'
        required: false
        default: 'false'
        type: string

jobs:
  scrape:
    runs-on: ubuntu-latest
    steps:
      - name: Verify secrets
        run: |
          if [ -z "${{ secrets.API_URL }}" ]; then
            echo "❌ Error: API_URL secret is not set"
            echo "Go to Settings → Secrets and variables → Actions → New repository secret"
            echo "Name: API_URL"
            echo "Value: https://jobscout-api.fly.dev"
            exit 1
          fi
          
          if [ -z "${{ secrets.ADMIN_TOKEN }}" ]; then
            echo "❌ Error: ADMIN_TOKEN secret is not set"
            echo "Go to Settings → Secrets and variables → Actions → New repository secret"
            echo "Name: ADMIN_TOKEN"
            echo "Value: (same as JOBSCOUT_ADMIN_TOKEN in Fly.io)"
            exit 1
          fi
          
          echo "✅ Secrets verified"

      - name: Set defaults
        id: defaults
        run: |
          # Set query (default: "automation engineer")
          if [ -z "${{ github.event.inputs.query }}" ]; then
            echo "query=automation engineer" >> $GITHUB_OUTPUT
          else
            echo "query=${{ github.event.inputs.query }}" >> $GITHUB_OUTPUT
          fi
          
          # Set use_ai boolean (default: false)
          if [ -z "${{ github.event.inputs.use_ai }}" ]; then
            echo "use_ai=false" >> $GITHUB_OUTPUT
          else
            USE_AI_LOWER=$(echo "${{ github.event.inputs.use_ai }}" | tr '[:upper:]' '[:lower:]')
            if [ "$USE_AI_LOWER" = "true" ] || [ "$USE_AI_LOWER" = "1" ] || [ "$USE_AI_LOWER" = "yes" ]; then
              echo "use_ai=true" >> $GITHUB_OUTPUT
            else
              echo "use_ai=false" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Trigger scrape
        run: |
          QUERY="${{ steps.defaults.outputs.query }}"
          USE_AI="${{ steps.defaults.outputs.use_ai }}"
          API_URL="${{ secrets.API_URL }}"
          ADMIN_TOKEN="${{ secrets.ADMIN_TOKEN }}"
          
          # Remove trailing slash from API_URL if present
          API_URL=$(echo "$API_URL" | sed 's|/$||')
          
          # Check if API_URL already contains /api/v1
          if echo "$API_URL" | grep -q "/api/v1"; then
            echo "⚠️  Warning: API_URL already contains /api/v1"
            echo "  API_URL: $API_URL"
            ENDPOINT="${API_URL}/admin/run"
          else
            ENDPOINT="${API_URL}/api/v1/admin/run"
          fi
          
          echo "Triggering scrape:"
          echo "  Query: $QUERY"
          echo "  Location: Remote"
          echo "  Use AI: $USE_AI"
          echo "  Base API_URL: $API_URL"
          echo "  Full Endpoint: $ENDPOINT"
          echo "  Token present: $([ -n "$ADMIN_TOKEN" ] && echo "yes" || echo "no")"
          
          # Test if backend is reachable
          echo ""
          echo "Testing backend connectivity..."
          HEALTH_CHECK=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/health" --max-time 5 || echo "000")
          if [ "$HEALTH_CHECK" = "200" ]; then
            echo "  ✅ Backend is reachable at $API_URL"
          else
            echo "  ⚠️  Backend health check returned: $HEALTH_CHECK"
            echo "  This might indicate the API_URL is incorrect or backend is down"
            echo "  Expected: https://jobscout-api.fly.dev (without /api/v1)"
          fi
          
          # Try to access docs to verify API structure
          echo ""
          echo "Verifying API structure..."
          DOCS_CHECK=$(curl -s -o /dev/null -w "%{http_code}" "${API_URL}/docs" --max-time 5 || echo "000")
          if [ "$DOCS_CHECK" = "200" ]; then
            echo "  ✅ API docs accessible - endpoint structure looks correct"
          else
            echo "  ⚠️  API docs check returned: $DOCS_CHECK"
          fi
          
          # Build JSON payload (escape quotes in query)
          QUERY_ESCAPED=$(echo "$QUERY" | sed 's/"/\\"/g')
          JSON_PAYLOAD="{\"query\":\"$QUERY_ESCAPED\",\"location\":\"Remote\",\"use_ai\":$USE_AI}"
          
          echo ""
          echo "Request payload:"
          echo "$JSON_PAYLOAD" | jq . 2>/dev/null || echo "$JSON_PAYLOAD"
          echo ""
          
          # Make request and capture response
          RESPONSE=$(curl -s -w "\n%{http_code}" -X POST "$ENDPOINT" \
            -H "Authorization: Bearer $ADMIN_TOKEN" \
            -H "Content-Type: application/json" \
            -d "$JSON_PAYLOAD" \
            --max-time 30 \
            --connect-timeout 10)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "Response:"
          echo "  HTTP Code: $HTTP_CODE"
          echo "  Body: $BODY"
          echo ""
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✅ Scrape triggered successfully"
            if echo "$BODY" | grep -q "run_id"; then
              RUN_ID=$(echo "$BODY" | grep -o '"run_id":[0-9]*' | grep -o '[0-9]*')
              echo "  Run ID: $RUN_ID"
            fi
            exit 0
          else
            echo "❌ Failed to trigger scrape (HTTP $HTTP_CODE)"
            case "$HTTP_CODE" in
              401)
                echo "  Error: Unauthorized - Check your ADMIN_TOKEN"
                ;;
              403)
                echo "  Error: Forbidden - Invalid ADMIN_TOKEN"
                ;;
              404)
                echo "  Error: Not Found - Check your API_URL endpoint"
                ;;
              500)
                echo "  Error: Server Error - Check backend logs"
                ;;
              *)
                echo "  Error: Unexpected response"
                ;;
            esac
            exit 1
          fi
        env:
          API_URL: ${{ secrets.API_URL }}
          ADMIN_TOKEN: ${{ secrets.ADMIN_TOKEN }}
